generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String
  role         String   @default("RESELLER")
  avatar       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  reseller      Reseller?
  notifications Notification[]
  activityLogs  ActivityLog[]

  @@index([email])
  @@index([role])
}

model Reseller {
  id             String  @id @default(cuid())
  userId         String  @unique
  companyName    String
  phone          String?
  address        String?
  commissionRate Float   @default(10)
  tier           String  @default("BRONZE")
  status         String  @default("ACTIVE")
  totalEarnings  Float   @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  referrals   Referral[]
  commissions Commission[]

  @@index([status])
  @@index([tier])
  @@index([userId])
}

model Referral {
  id              String   @id @default(cuid())
  resellerId      String
  companyName     String
  contactName     String
  contactEmail    String
  contactPhone    String?
  productInterest String   @default("STARTER")
  estimatedValue  Float?
  dealValue       Float?
  status          String   @default("NEW")
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  reseller   Reseller    @relation(fields: [resellerId], references: [id], onDelete: Cascade)
  commission Commission?

  @@index([resellerId])
  @@index([status])
  @@index([createdAt])
}

model Commission {
  id               String   @id @default(cuid())
  referralId       String   @unique
  resellerId       String
  dealValue        Float
  commissionRate   Float
  commissionAmount Float
  status           String   @default("PENDING")
  paidAt           DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  referral Referral @relation(fields: [referralId], references: [id], onDelete: Cascade)
  reseller Reseller @relation(fields: [resellerId], references: [id], onDelete: Cascade)

  @@index([resellerId])
  @@index([status])
  @@index([createdAt])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  read      Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
}

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  entityType String
  entityId   String
  metadata   String?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model TierConfig {
  id           String @id @default(cuid())
  tier         String @unique
  minReferrals Int    @default(0)
  minRevenue   Float  @default(0)
  bonusRate    Float  @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model SystemSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}
